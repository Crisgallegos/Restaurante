<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Restaurante App</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding: 20px; background-color: #fff3e0; }
    .nav-link { cursor: pointer; }
    .btn-table { width: 120px; height: 60px; font-size: 1rem; }
  </style>
</head>
<body>

<!-- NAVBAR -->
<nav class="navbar navbar-expand-lg navbar-light bg-warning mb-4 rounded">
  <div class="container-fluid">
    <a class="navbar-brand">Restaurante</a>
    <div class="collapse navbar-collapse">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item"><span class="nav-link" onclick="showSection('tables')">Mesas</span></li>
        <li class="nav-item"><span class="nav-link" onclick="showSection('orders')">Pedidos</span></li>
        <li class="nav-item"><span class="nav-link" onclick="showSection('caja')">Caja</span></li>
      </ul>
    </div>
  </div>
</nav>

<!-- SECCIONES -->
<div id="tables-section">
  <h3>Mesas</h3>
  <div id="tables-container" class="d-flex flex-wrap"></div>
</div>

<div id="orders-section" class="d-none">
  <h3>Pedidos</h3>
  <div id="orders-container"></div>
</div>

<div id="caja-section" class="d-none">
  <h3>Caja</h3>
  <div id="caja-container"></div>
</div>

<!-- MODAL MENU -->
<div class="modal fade" id="menuModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-warning">
        <h5 class="modal-title" id="menu-title">Menú</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <ul id="order-items" class="list-group mb-3"></ul>
        <div id="menu-container"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-success" id="confirm-order-btn">Confirmar Pedido</button>
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
<script>
  let currentOrder = [];
  let selectedTableId = null;

  function showSection(section) {
    document.getElementById("tables-section").classList.add("d-none");
    document.getElementById("orders-section").classList.add("d-none");
    document.getElementById("caja-section").classList.add("d-none");
    document.getElementById(`${section}-section`).classList.remove("d-none");
  }

  function renderTables(tables) {
    const container = document.getElementById("tables-container");
    container.innerHTML = "";
    tables.forEach(t => {
      const btn = document.createElement("button");
      btn.className = `btn btn-table m-2 ${t.status==='ocupada'?'btn-danger':'btn-success'}`;
      btn.textContent = `${t.name} (${t.status})`;
      btn.onclick = () => openMenuModal(t.id, t.name);
      container.appendChild(btn);
    });
  }

  function openMenuModal(tableId, tableName) {
    selectedTableId = tableId;
    google.script.run.withSuccessHandler(renderMenu).fetchMenu();
    document.getElementById("menu-title").textContent = `Menú para ${tableName}`;
    currentOrder = [];
    document.getElementById("order-items").innerHTML = "";
    new bootstrap.Modal(document.getElementById("menuModal")).show();
  }

  function renderMenu(menu) {
    const container = document.getElementById("menu-container");
    container.innerHTML = "";
    menu.forEach(item => {
      const row = document.createElement("div");
      row.className = "d-flex justify-content-between align-items-center border p-2 rounded mb-1";
      row.innerHTML = `<span>${item.name} - $${item.price}</span><button class="btn btn-sm btn-primary">Agregar</button>`;
      row.querySelector("button").onclick = () => addItemToOrder(item);
      container.appendChild(row);
    });
  }

  function addItemToOrder(item) {
    currentOrder.push(item);
    const li = document.createElement("li");
    li.className = "list-group-item";
    li.textContent = `${item.name} - $${item.price}`;
    document.getElementById("order-items").appendChild(li);
  }

  function saveOrder() {
    if(!currentOrder.length) { alert("No hay ítems en el pedido"); return; }
    google.script.run.withSuccessHandler(loadData).postOrder(selectedTableId, currentOrder);
    new bootstrap.Modal(document.getElementById("menuModal")).hide();
  }

  function renderOrders(orders) {
    const container = document.getElementById("orders-container");
    container.innerHTML = "";
    orders.forEach(o => {
      const div = document.createElement("div");
      div.className = "border rounded p-2 mb-2";
      div.innerHTML = `<strong>Mesa ${o.tableId}</strong> - Estado: ${o.status}<br>${o.items.map(i=>i.name).join(", ")}`;
      container.appendChild(div);
    });
  }

  function renderCaja(orders) {
    const container = document.getElementById("caja-container");
    container.innerHTML = "";
    orders.filter(o=>o.status==="entregado").forEach(o=>{
      const div = document.createElement("div");
      div.className = "border rounded p-2 mb-2";
      const total = o.items.reduce((sum,i)=>sum+i.price,0);
      div.innerHTML = `<strong>Mesa ${o.tableId}</strong><br>${o.items.map(i=>i.name+" $"+i.price).join(", ")}<br>Total: $${total}`;
      container.appendChild(div);
    });
  }

  function loadData() {
    google.script.run.withSuccessHandler(renderTables).fetchTables();
    google.script.run.withSuccessHandler(renderOrders).fetchOrders();
    google.script.run.withSuccessHandler(renderCaja).fetchOrders();
  }

  document.addEventListener("DOMContentLoaded", () => {
    loadData();
    document.getElementById("confirm-order-btn").addEventListener("click", saveOrder);
  });
</script>
</body>
</html>

